{% extends "base.html" %}

{% block content %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h1>{{ project.name }}</h1>
            <button onclick="openPopup()" class="btn btn-primary">Update Summary</button>
        </div>

        <h2>Project Summary</h2>
        <p id="summary">{{ project.summary }}</p>

        <div id="popup" class="popup" style="display: none;">
            <form id="update-summary-form" method="POST">  <!-- Give the form an ID -->
                <label for="updated-summary">Updated Summary:</label>
                <textarea id="updated-summary" name="updated_summary" class="form-control"></textarea>
                <button type="submit" class="btn btn-primary">Confirm</button>
                <button type="button" class="btn btn-secondary" onclick="cancelUpdate()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('update-summary-form').addEventListener('submit', function(event) {
            // Prevent the form from being submitted
            event.preventDefault();

            // Get the updated summary from the textarea
            var updatedSummary = document.getElementById("updated-summary").value;

            fetch(`/project/{{ project.id }}/summary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ updated_summary: updatedSummary, action: 'update_summary' })  // Include 'action'
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Summary updated successfully');
                        document.getElementById("popup").style.display = "none";  // Close the popup
                        window.location.reload()
                    } else {
                        console.log('Error updating summary');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function openPopup() {
            document.getElementById("popup").style.display = "block";

            // Make a request to the '/ask' route to get the updated summary
            fetch('/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ project_id: '{{ project.id }}', user_input: 'Provided a detailed summary of the project in bullet format.' })
            })
                .then(response => response.json())
                .then(data => {
                    const updatedSummary = data.updated_summary;
                    document.getElementById("updated-summary").value = updatedSummary;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function cancelUpdate() {
            document.getElementById("popup").style.display = "none";
        }
    </script>

{% endblock %}
